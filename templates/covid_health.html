{% extends "base.html" %}

{% block title %}COVID-19 건강 분석{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-virus text-danger me-2"></i>
                COVID-19 건강 분석
            </h2>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>홈으로
            </a>
        </div>
    </div>
</div>

<!-- 필터 섹션 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    필터 설정
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="incomeGroupFilter" class="form-label">소득 그룹</label>
                        <select class="form-select" id="incomeGroupFilter">
                            <option value="">전체</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="regionFilter" class="form-label">지역</label>
                        <select class="form-select" id="regionFilter">
                            <option value="">전체</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>필터 적용
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 차트 섹션 -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-scatter me-2"></i>
                    건강 지출 vs COVID-19 사망률
                </h5>
            </div>
            <div class="card-body">
                <div id="covidMortalityChart" style="height: 500px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 데이터 테이블 섹션 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    분석 데이터
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="dataTable">
                        <thead>
                            <tr>
                                <th>국가</th>
                                <th>지역</th>
                                <th>소득 그룹</th>
                                <th>건강 지출 per Capita ($)</th>
                                <th>COVID-19 사망률 (per 100k)</th>
                                <th>의료진 밀도 (per 1000)</th>
                                <th>병상 수 (per 1000)</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- 데이터가 여기에 동적으로 로드됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 통계 요약 섹션 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    통계 요약
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="statsContainer">
                    <!-- 통계가 여기에 동적으로 로드됩니다 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentData = [];

// 페이지 로드 시 데이터 로드
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    loadChart();
});

// 데이터 로드
async function loadData() {
    try {
        const response = await fetch('/api/covid-health-data');
        const result = await response.json();
        
        if (result.error) {
            console.error('데이터 로드 오류:', result.error);
            return;
        }
        
        currentData = result.data;
        populateFilters(result);
        populateTable(currentData);
        populateStats(currentData);
    } catch (error) {
        console.error('데이터 로드 실패:', error);
    }
}

// 필터 옵션 채우기
function populateFilters(data) {
    const incomeGroups = [...new Set(data.income_groups)].sort();
    const regions = [...new Set(data.regions)].sort();
    
    const incomeSelect = document.getElementById('incomeGroupFilter');
    const regionSelect = document.getElementById('regionFilter');
    
    incomeGroups.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        incomeSelect.appendChild(option);
    });
    
    regions.forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        option.textContent = region;
        regionSelect.appendChild(option);
    });
}

// 테이블 데이터 채우기
function populateTable(data) {
    const tbody = document.getElementById('dataTableBody');
    tbody.innerHTML = '';
    
    data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.Country || 'N/A'}</td>
            <td>${row.Region || 'N/A'}</td>
            <td>${row.Income_Group || 'N/A'}</td>
            <td>${row.Health_Expenditure_Per_Capita ? row.Health_Expenditure_Per_Capita.toLocaleString() : 'N/A'}</td>
            <td>${row.COVID_Mortality_Rate ? row.COVID_Mortality_Rate.toFixed(2) : 'N/A'}</td>
            <td>${row.Physicians_Per_1000 ? row.Physicians_Per_1000.toFixed(2) : 'N/A'}</td>
            <td>${row.Hospital_Beds_Per_1000 ? row.Hospital_Beds_Per_1000.toFixed(2) : 'N/A'}</td>
        `;
        tbody.appendChild(tr);
    });
}

// 통계 요약 채우기
function populateStats(data) {
    const container = document.getElementById('statsContainer');
    
    if (data.length === 0) {
        container.innerHTML = '<p class="text-muted">데이터가 없습니다.</p>';
        return;
    }
    
    const mortalityRates = data.map(d => d.COVID_Mortality_Rate).filter(r => !isNaN(r));
    const healthExpenditure = data.map(d => d.Health_Expenditure_Per_Capita).filter(h => !isNaN(h));
    const physicians = data.map(d => d.Physicians_Per_1000).filter(p => !isNaN(p));
    
    const avgMortality = mortalityRates.length > 0 ? mortalityRates.reduce((a, b) => a + b, 0) / mortalityRates.length : 0;
    const avgExpenditure = healthExpenditure.length > 0 ? healthExpenditure.reduce((a, b) => a + b, 0) / healthExpenditure.length : 0;
    const avgPhysicians = physicians.length > 0 ? physicians.reduce((a, b) => a + b, 0) / physicians.length : 0;
    
    container.innerHTML = `
        <div class="col-md-3">
            <div class="text-center">
                <h4 class="text-primary">${data.length}</h4>
                <p class="text-muted">분석 국가 수</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <h4 class="text-danger">${avgMortality.toFixed(2)}</h4>
                <p class="text-muted">평균 사망률 (per 100k)</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <h4 class="text-success">$${avgExpenditure.toLocaleString()}</h4>
                <p class="text-muted">평균 건강 지출</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <h4 class="text-info">${avgPhysicians.toFixed(2)}</h4>
                <p class="text-muted">평균 의료진 밀도</p>
            </div>
        </div>
    `;
}

// 차트 로드
async function loadChart() {
    try {
        const response = await fetch('/api/chart/covid-mortality-scatter');
        const chartData = await response.json();
        
        if (chartData.error) {
            console.error('차트 로드 오류:', chartData.error);
            return;
        }
        
        Plotly.newPlot('covidMortalityChart', chartData.data, chartData.layout, {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
        });
    } catch (error) {
        console.error('차트 로드 실패:', error);
    }
}

// 필터 적용
function applyFilters() {
    const incomeGroup = document.getElementById('incomeGroupFilter').value;
    const region = document.getElementById('regionFilter').value;
    
    let filteredData = currentData;
    
    if (incomeGroup) {
        filteredData = filteredData.filter(d => d.Income_Group === incomeGroup);
    }
    
    if (region) {
        filteredData = filteredData.filter(d => d.Region === region);
    }
    
    populateTable(filteredData);
    populateStats(filteredData);
}
</script>
{% endblock %} 