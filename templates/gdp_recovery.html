{% extends "base.html" %}

{% block title %}GDP 회복 분석{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-chart-bar text-primary me-2"></i>
                GDP 회복 분석
            </h2>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>홈으로
            </a>
        </div>
    </div>
</div>

<!-- 필터 섹션 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    필터 설정
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="incomeGroupFilter" class="form-label">소득 그룹</label>
                        <select class="form-select" id="incomeGroupFilter">
                            <option value="">전체</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="regionFilter" class="form-label">지역</label>
                        <select class="form-select" id="regionFilter">
                            <option value="">전체</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>필터 적용
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 차트 섹션 -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-scatter me-2"></i>
                    GDP per Capita vs 회복률 산점도
                </h5>
            </div>
            <div class="card-body">
                <div id="gdpRecoveryChart" style="height: 500px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 데이터 테이블 섹션 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    분석 데이터
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="dataTable">
                        <thead>
                            <tr>
                                <th>국가</th>
                                <th>지역</th>
                                <th>소득 그룹</th>
                                <th>GDP per Capita (2019)</th>
                                <th>GDP 회복률 (%)</th>
                                <th>GDP 성장률 (2020)</th>
                                <th>GDP 성장률 (2021)</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- 데이터가 여기에 동적으로 로드됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 통계 요약 섹션 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    통계 요약
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="statsContainer">
                    <!-- 통계가 여기에 동적으로 로드됩니다 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentData = [];

// 페이지 로드 시 데이터 로드
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    loadChart();
});

// 데이터 로드
async function loadData() {
    try {
        const response = await fetch('/api/gdp-recovery-data');
        const result = await response.json();
        
        if (result.error) {
            console.error('데이터 로드 오류:', result.error);
            return;
        }
        
        currentData = result.data;
        populateFilters(result);
        populateTable(currentData);
        populateStats(currentData);
    } catch (error) {
        console.error('데이터 로드 실패:', error);
    }
}

// 필터 옵션 채우기
function populateFilters(data) {
    const incomeGroups = [...new Set(data.income_groups)].sort();
    const regions = [...new Set(data.regions)].sort();
    
    const incomeSelect = document.getElementById('incomeGroupFilter');
    const regionSelect = document.getElementById('regionFilter');
    
    incomeGroups.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        incomeSelect.appendChild(option);
    });
    
    regions.forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        option.textContent = region;
        regionSelect.appendChild(option);
    });
}

// 테이블 데이터 채우기
function populateTable(data) {
    const tbody = document.getElementById('dataTableBody');
    tbody.innerHTML = '';
    
    data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.Country || 'N/A'}</td>
            <td>${row.Region || 'N/A'}</td>
            <td>${row.Income_Group || 'N/A'}</td>
            <td>${row.GDP_Per_Capita_2019 ? row.GDP_Per_Capita_2019.toLocaleString() : 'N/A'}</td>
            <td>${row.GDP_Recovery_Rate ? row.GDP_Recovery_Rate.toFixed(2) : 'N/A'}</td>
            <td>${row.GDP_Growth_2020 ? row.GDP_Growth_2020.toFixed(2) : 'N/A'}</td>
            <td>${row.GDP_Growth_2021 ? row.GDP_Growth_2021.toFixed(2) : 'N/A'}</td>
        `;
        tbody.appendChild(tr);
    });
}

// 통계 요약 채우기
function populateStats(data) {
    const container = document.getElementById('statsContainer');
    
    if (data.length === 0) {
        container.innerHTML = '<p class="text-muted">데이터가 없습니다.</p>';
        return;
    }
    
    const recoveryRates = data.map(d => d.GDP_Recovery_Rate).filter(r => !isNaN(r));
    const gdpPerCapita = data.map(d => d.GDP_Per_Capita_2019).filter(g => !isNaN(g));
    
    const avgRecovery = recoveryRates.length > 0 ? recoveryRates.reduce((a, b) => a + b, 0) / recoveryRates.length : 0;
    const avgGDP = gdpPerCapita.length > 0 ? gdpPerCapita.reduce((a, b) => a + b, 0) / gdpPerCapita.length : 0;
    
    container.innerHTML = `
        <div class="col-md-3">
            <div class="text-center">
                <h4 class="text-primary">${data.length}</h4>
                <p class="text-muted">분석 국가 수</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <h4 class="text-success">${avgRecovery.toFixed(2)}%</h4>
                <p class="text-muted">평균 회복률</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <h4 class="text-info">$${avgGDP.toLocaleString()}</h4>
                <p class="text-muted">평균 GDP per Capita</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <h4 class="text-warning">${recoveryRates.length}</h4>
                <p class="text-muted">유효 데이터 수</p>
            </div>
        </div>
    `;
}

// 차트 로드
async function loadChart() {
    try {
        const response = await fetch('/api/chart/gdp-recovery-scatter');
        const chartData = await response.json();
        
        if (chartData.error) {
            console.error('차트 로드 오류:', chartData.error);
            return;
        }
        
        Plotly.newPlot('gdpRecoveryChart', chartData.data, chartData.layout, {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
        });
    } catch (error) {
        console.error('차트 로드 실패:', error);
    }
}

// 필터 적용
function applyFilters() {
    const incomeGroup = document.getElementById('incomeGroupFilter').value;
    const region = document.getElementById('regionFilter').value;
    
    let filteredData = currentData;
    
    if (incomeGroup) {
        filteredData = filteredData.filter(d => d.Income_Group === incomeGroup);
    }
    
    if (region) {
        filteredData = filteredData.filter(d => d.Region === region);
    }
    
    populateTable(filteredData);
    populateStats(filteredData);
}
</script>
{% endblock %} 